<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Attendance System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 25px; }
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        input[type="text"], input[type="email"], input[type="password"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        .camera-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        #video {
            width: 100%;
            max-width: 400px;
            border-radius: 12px;
            display: block;
            margin: 0 auto 15px;
            background: #000;
        }
        #canvas { display: none; }
        .captured-photo {
            width: 100%;
            max-width: 400px;
            border-radius: 12px;
            margin: 15px auto;
            display: none;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success {
            background: #28a745;
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 18px;
        }
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .button-group { text-align: center; }
        .location-info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-card h3 { font-size: 2em; margin-bottom: 5px; }
        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
            display: block;
        }
        .records-table thead {
            background: #667eea;
            color: white;
        }
        .records-table th, .records-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .records-table tbody tr:hover { background: #f8f9fa; }
        .photo-thumb {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-photo {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .no-records {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .login-container h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }
        .locked-message {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        .locked-message h2 {
            color: #dc3545;
            margin-bottom: 15px;
        }
        .map-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        .map-link:hover {
            text-decoration: underline;
        }
        @media (max-width: 768px) {
            .records-table { font-size: 14px; }
            .records-table th, .records-table td { padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Teacher Attendance System</h1>
            <p>Secure Attendance Management with Location Tracking</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('mark')">Mark Attendance</button>
            <button class="nav-tab" onclick="switchTab('view')">Admin Dashboard üîí</button>
        </div>

        <!-- Mark Attendance Tab -->
        <div id="markTab" class="tab-content active">
            <div id="statusMessage" class="status"></div>
            <form id="attendanceForm">
                <div class="form-group">
                    <label for="teacherName">Teacher Name *</label>
                    <input type="text" id="teacherName" required placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="teacherId">Teacher ID *</label>
                    <input type="text" id="teacherId" required placeholder="Enter your ID">
                </div>
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="department">Department *</label>
                    <select id="department" required>
                        <option value="">Select Department</option>
                        <option value="Mathematics">Mathematics</option>
                        <option value="Science">Science</option>
                        <option value="English">English</option>
                        <option value="History">History</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Physical Education">Physical Education</option>
                        <option value="Arts">Arts</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="info-box">
                    <strong>üìÖ Date:</strong> <span id="currentDate"></span><br>
                    <strong>üïê Time:</strong> <span id="currentTime"></span>
                </div>
                <div class="location-info" id="locationInfo">
                    <strong>üìç Location:</strong><br>
                    <span id="locationText">Fetching location...</span>
                </div>
                <div class="camera-section">
                    <label>üì∏ Capture Photo *</label>
                    <video id="video" autoplay></video>
                    <img id="capturedPhoto" class="captured-photo">
                    <canvas id="canvas"></canvas>
                    <div class="button-group">
                        <button type="button" class="btn btn-primary" id="startCamera">Start Camera</button>
                        <button type="button" class="btn btn-secondary" id="captureBtn" style="display:none;">Capture Photo</button>
                        <button type="button" class="btn btn-secondary" id="retakeBtn" style="display:none;">Retake</button>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">‚úì Mark Attendance</button>
            </form>
        </div>

        <!-- Admin Dashboard Tab -->
        <div id="viewTab" class="tab-content">
            <div id="adminLogin" class="login-container">
                <h2>üîê Admin Login</h2>
                <div class="form-group">
                    <label for="adminPassword">Enter Admin Password</label>
                    <input type="password" id="adminPassword" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" onclick="adminLogin()" style="width: 100%;">Login</button>
                <p style="margin-top: 20px; text-align: center; color: #6c757d; font-size: 14px;">
                    Default Password: <strong>admin123</strong>
                </p>
            </div>

            <div id="adminDashboard" style="display: none;">
                <div style="text-align: right; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="adminLogout()">Logout</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalRecords">0</h3>
                        <p>Total Records</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="todayRecords">0</h3>
                        <p>Today's Attendance</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="uniqueTeachers">0</h3>
                        <p>Unique Teachers</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; text-align: right;">
                    <button class="btn btn-danger" onclick="clearAllRecords()">Clear All Records</button>
                    <button class="btn btn-primary" onclick="exportToCSV()">Export to CSV</button>
                </div>
                
                <div id="recordsContainer"></div>
            </div>
        </div>
    </div>

    <!-- Modal for viewing full details -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div id="modalBody"></div>
            <button class="btn btn-secondary" onclick="closeModal()" style="width: 100%; margin-top: 20px;">Close</button>
        </div>
    </div>

    <script>
        let videoStream = null, photoData = null, locationData = null;
        const ADMIN_PASSWORD = 'admin123'; // Change this password
        let isAdminLoggedIn = false;

        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (tab === 'mark') {
                document.querySelector('.nav-tab:first-child').classList.add('active');
                document.getElementById('markTab').classList.add('active');
            } else {
                document.querySelector('.nav-tab:last-child').classList.add('active');
                document.getElementById('viewTab').classList.add('active');
                if (isAdminLoggedIn) {
                    document.getElementById('adminLogin').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'block';
                    loadRecords();
                } else {
                    document.getElementById('adminLogin').style.display = 'block';
                    document.getElementById('adminDashboard').style.display = 'none';
                }
            }
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                loadRecords();
                document.getElementById('adminPassword').value = '';
            } else {
                alert('‚ùå Incorrect password! Please try again.');
                document.getElementById('adminPassword').value = '';
            }
        }

        function adminLogout() {
            isAdminLoggedIn = false;
            document.getElementById('adminLogin').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
        }

        // Allow Enter key for login
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    adminLogin();
                }
            });
        });

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US');
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);

        function getLocation() {
            if (navigator.geolocation) {
                document.getElementById('locationInfo').style.display = 'block';
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        locationData = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        };
                        
                        // Get address from coordinates using reverse geocoding
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${locationData.latitude}&lon=${locationData.longitude}`)
                            .then(response => response.json())
                            .then(data => {
                                locationData.address = data.display_name;
                                document.getElementById('locationText').innerHTML = 
                                    `<strong>Address:</strong> ${data.display_name}<br>` +
                                    `<strong>Coordinates:</strong> ${locationData.latitude.toFixed(6)}, ${locationData.longitude.toFixed(6)}<br>` +
                                    `<strong>Accuracy:</strong> ${locationData.accuracy.toFixed(0)} meters<br>` +
                                    `<a href="https://www.google.com/maps?q=${locationData.latitude},${locationData.longitude}" target="_blank" class="map-link">üìç View on Google Maps</a>`;
                            })
                            .catch(() => {
                                document.getElementById('locationText').innerHTML = 
                                    `Latitude: ${locationData.latitude.toFixed(6)}<br>` +
                                    `Longitude: ${locationData.longitude.toFixed(6)}<br>` +
                                    `Accuracy: ${locationData.accuracy.toFixed(0)} meters<br>` +
                                    `<a href="https://www.google.com/maps?q=${locationData.latitude},${locationData.longitude}" target="_blank" class="map-link">üìç View on Google Maps</a>`;
                            });
                    },
                    (error) => {
                        document.getElementById('locationText').textContent = 'Location access denied or unavailable';
                    }
                );
            }
        }
        getLocation();

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const capturedPhoto = document.getElementById('capturedPhoto');

        document.getElementById('startCamera').addEventListener('click', async () => {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = videoStream;
                video.style.display = 'block';
                document.getElementById('startCamera').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'inline-block';
            } catch (err) {
                showStatus('Camera access denied or unavailable', 'error');
            }
        });

        document.getElementById('captureBtn').addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            photoData = canvas.toDataURL('image/jpeg');
            capturedPhoto.src = photoData;
            capturedPhoto.style.display = 'block';
            video.style.display = 'none';
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'inline-block';
            if (videoStream) videoStream.getTracks().forEach(track => track.stop());
        });

        document.getElementById('retakeBtn').addEventListener('click', async () => {
            capturedPhoto.style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'none';
            photoData = null;
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = videoStream;
                video.style.display = 'block';
                document.getElementById('captureBtn').style.display = 'inline-block';
            } catch (err) {
                showStatus('Camera access denied', 'error');
            }
        });

        document.getElementById('attendanceForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!photoData) {
                showStatus('Please capture your photo before submitting', 'error');
                return;
            }
            if (!locationData) {
                showStatus('Please allow location access', 'error');
                return;
            }

            const attendanceData = {
                id: Date.now(),
                teacherName: document.getElementById('teacherName').value,
                teacherId: document.getElementById('teacherId').value,
                email: document.getElementById('email').value,
                department: document.getElementById('department').value,
                date: document.getElementById('currentDate').textContent,
                time: document.getElementById('currentTime').textContent,
                location: locationData,
                photo: photoData,
                timestamp: new Date().toISOString()
            };

            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            records.push(attendanceData);
            localStorage.setItem('attendanceRecords', JSON.stringify(records));
            showStatus('‚úì Attendance marked successfully!', 'success');

            setTimeout(() => {
                document.getElementById('attendanceForm').reset();
                capturedPhoto.style.display = 'none';
                document.getElementById('retakeBtn').style.display = 'none';
                document.getElementById('startCamera').style.display = 'inline-block';
                photoData = null;
                getLocation();
            }, 2000);
        });

        function loadRecords() {
            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            document.getElementById('totalRecords').textContent = records.length;
            const today = new Date().toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            document.getElementById('todayRecords').textContent = records.filter(r => r.date === today).length;
            document.getElementById('uniqueTeachers').textContent = new Set(records.map(r => r.teacherId)).size;

            const container = document.getElementById('recordsContainer');
            if (records.length === 0) {
                container.innerHTML = '<div class="no-records">No attendance records found</div>';
                return;
            }

            let html = '<table class="records-table"><thead><tr>';
            html += '<th>Photo</th><th>Name</th><th>ID</th><th>Department</th><th>Date</th><th>Time</th><th>Location</th><th>Action</th>';
            html += '</tr></thead><tbody>';
            records.reverse().forEach(record => {
                const mapLink = record.location ? 
                    `<a href="https://www.google.com/maps?q=${record.location.latitude},${record.location.longitude}" target="_blank" class="map-link">View Map</a>` : 
                    'N/A';
                html += `<tr>
                    <td><img src="${record.photo}" class="photo-thumb" onclick="viewDetails(${record.id})"></td>
                    <td>${record.teacherName}</td>
                    <td>${record.teacherId}</td>
                    <td>${record.department}</td>
                    <td>${record.date}</td>
                    <td>${record.time}</td>
                    <td>${mapLink}</td>
                    <td><button class="btn btn-primary" onclick="viewDetails(${record.id})">View</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function viewDetails(id) {
            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            const record = records.find(r => r.id === id);
            if (!record) return;

            let html = `<img src="${record.photo}" class="modal-photo">
                <h2>${record.teacherName}</h2>
                <p><strong>Teacher ID:</strong> ${record.teacherId}</p>
                <p><strong>Email:</strong> ${record.email}</p>
                <p><strong>Department:</strong> ${record.department}</p>
                <p><strong>Date:</strong> ${record.date}</p>
                <p><strong>Time:</strong> ${record.time}</p>`;

            if (record.location) {
                html += `<p><strong>Location Details:</strong></p>`;
                if (record.location.address) {
                    html += `<p><strong>Address:</strong> ${record.location.address}</p>`;
                }
                html += `<p><strong>Coordinates:</strong> ${record.location.latitude.toFixed(6)}, ${record.location.longitude.toFixed(6)}</p>
                    <p><strong>Accuracy:</strong> ${record.location.accuracy.toFixed(0)} meters</p>
                    <p><a href="https://www.google.com/maps?q=${record.location.latitude},${record.location.longitude}" target="_blank" class="map-link">üìç Open in Google Maps</a></p>`;
            }

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function clearAllRecords() {
            if (confirm('Are you sure you want to delete all attendance records? This action cannot be undone.')) {
                localStorage.removeItem('attendanceRecords');
                loadRecords();
                alert('‚úì All records have been cleared');
            }
        }

        function exportToCSV() {
            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            if (records.length === 0) { 
                alert('No records to export'); 
                return; 
            }

            let csv = 'Name,ID,Email,Department,Date,Time,Latitude,Longitude,Address,Google Maps Link\n';
            records.forEach(r => {
                const lat = r.location ? r.location.latitude : 'N/A';
                const lon = r.location ? r.location.longitude : 'N/A';
                const address = r.location && r.location.address ? r.location.address.replace(/"/g, '""') : 'N/A';
                const mapLink = r.location ? `https://www.google.com/maps?q=${lat},${lon}` : 'N/A';
                csv += `"${r.teacherName}","${r.teacherId}","${r.email}","${r.department}","${r.date}","${r.time}","${lat}","${lon}","${address}","${mapLink}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `attendance_records_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
        }
    </script>
</body>
</html>